generator client {
  provider = "prisma-client"
  output   = "../generated/prisma/client"
}

datasource db {
  provider = "postgresql"
}

model Retailer {
  id        String   @id @default(cuid())
  name      String   @unique
  category  String
  logoUrl   String?
  scrapedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  flyers    Flyer[]
  offers    Offer[]
  stores    Store[]

  @@index([name])
  @@index([category])
}

model Flyer {
  id           String   @id @default(cuid())
  retailerId   String
  title        String
  pages        Int
  validFrom    DateTime
  validUntil   DateTime
  url          String   @unique
  pdfUrl       String?
  scrapedAt    DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  thumbnailUrl String?
  retailer     Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  offers       Offer[]

  @@index([retailerId])
  @@index([validFrom])
  @@index([validUntil])
  @@index([url])
}

model Store {
  id           String   @id @default(cuid())
  retailerId   String
  address      String
  city         String
  postalCode   String
  latitude     Float?
  longitude    Float?
  phone        String?
  openingHours String?
  scrapedAt    DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  retailer     Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@unique([retailerId, address])
  @@index([retailerId])
  @@index([city])
  @@index([postalCode])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  brand       String?
  category    String?
  description String?
  imageUrl    String?
  scrapedAt   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  offers      Offer[]

  @@index([name])
  @@index([brand])
  @@index([category])
}

model Offer {
  id                 String    @id @default(cuid())
  flyerId            String?
  productId          String?
  retailerId         String
  productName        String
  brand              String?
  category           String?
  currentPrice       Float
  oldPrice           Float?
  discount           Float?
  discountPercentage Float?
  unitPrice          String?
  url                String    @unique
  imageUrl           String?
  validUntil         DateTime?
  scrapedAt          DateTime  @default(now())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  flyer              Flyer?    @relation(fields: [flyerId], references: [id])
  product            Product?  @relation(fields: [productId], references: [id])
  retailer           Retailer  @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@index([flyerId])
  @@index([productId])
  @@index([retailerId])
  @@index([productName])
  @@index([currentPrice])
  @@index([validUntil])
  @@index([url])
}

model ScrapingLog {
  id           String    @id @default(cuid())
  type         String
  status       String
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  itemsScraped Int       @default(0)
  errors       String?
  metadata     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([type])
  @@index([status])
  @@index([startedAt])
}
